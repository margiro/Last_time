<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Playlist - Marcos</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --danger: #ef4444;
            --success: #22c55e;
            --warning: #f59e0b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }

        h1, h2, h3 { color: #0f172a; margin-top: 0; }

        .container { display: grid; gap: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        .actions-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }

        button {
            padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; transition: opacity 0.2s;
        }
        button:hover { opacity: 0.9; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-outline { border: 1px solid #ccc; background: white; color: #333; }
        .btn-icon { padding: 4px 8px; font-size: 1.1em; background: transparent; }
        
        /* Bot√≥n espec√≠fico para sumar escuchas */
        .btn-plus {
            background-color: #dbeafe; 
            color: #1e40af;
            padding: 2px 8px;
            font-size: 0.8rem;
            margin-left: 8px;
            border-radius: 12px;
            font-weight: bold;
        }
        .btn-plus:hover { background-color: #bfdbfe; }

        input, select { padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; margin-right: 10px; margin-bottom: 10px; }
        label { display: block; font-size: 0.85em; color: #64748b; margin-bottom: 4px; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th, td { text-align: left; padding: 10px; border-bottom: 1px solid #e2e8f0; }
        th { background-color: #f1f5f9; font-weight: 600; }
        
        .active-row { border-left: 4px solid var(--success); background-color: #f0fdf4; }
        .inactive-row { opacity: 0.7; }

        .chart-container { position: relative; height: 300px; width: 100%; }
        .stats { display: flex; justify-content: space-between; font-size: 0.9em; color: #64748b; margin-bottom: 10px; }

        /* Estilos del Modal */
        .modal {
            display: none; 
            position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto;
            background-color: rgba(0,0,0,0.5);
            align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: #fff; padding: 25px; border-radius: 8px;
            width: 90%; max-width: 400px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .modal-actions { text-align: right; margin-top: 15px; }
        .form-group { margin-bottom: 12px; }
        .form-group input { width: 100%; box-sizing: border-box; }

    </style>
</head>
<body>

    <h1>üéµ Playlist Manager</h1>

    <div class="actions-bar">
        <input type="file" id="csvFileInput" accept=".csv" style="display:none">
        <button onclick="document.getElementById('csvFileInput').click()" class="btn-outline">üìÇ Importar CSV</button>
        <button onclick="exportCSV()" class="btn-outline">üíæ Exportar CSV</button>
        <button onclick="clearData()" class="btn-outline" style="color:var(--danger); border-color:var(--danger)">üóëÔ∏è Borrar Todo</button>
    </div>

    <div class="container">
        
        <div class="card">
            <h2>Registrar Nueva Canci√≥n</h2>
            <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end;">
                <div><label>Canci√≥n</label><input type="text" id="inputCancion" placeholder="Nombre..."></div>
                <div><label>Fecha Entrada</label><input type="date" id="inputFecha"></div>
                <div><label>Escuchas</label><input type="number" id="inputEscuchas" value="0" style="width: 70px;"></div>
                <button onclick="addSong()" class="btn-primary" style="margin-bottom: 10px;">A√±adir</button>
            </div>
        </div>

        <div class="card">
            <h2>Escuchas (Top 25 Activas)</h2>
            <div class="chart-container"><canvas id="listenChart"></canvas></div>
        </div>

        <div class="card">
            <div class="stats">
                <span id="totalSongsCount">Total: 0</span>
                <span id="activeSongsCount" style="color: var(--success); font-weight:bold;">Activas: 0</span>
            </div>
            <h2>Listado Completo</h2>
            <div style="overflow-x: auto;">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Canci√≥n</th>
                            <th>Entrada</th>
                            <th>Salida</th>
                            <th>D√≠as</th>
                            <th>Escuchas</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <h3>Editar Entrada</h3>
            <div class="form-group">
                <label>Nombre de la Canci√≥n</label>
                <input type="text" id="editCancion">
            </div>
            <div class="form-group">
                <label>Fecha Entrada</label>
                <input type="date" id="editFechaEntrada">
            </div>
            <div class="form-group">
                <label>Fecha Salida (Dejar vac√≠o si sigue activa)</label>
                <input type="date" id="editFechaSalida">
            </div>
            <div class="form-group">
                <label>Escuchas</label>
                <input type="number" id="editEscuchas">
            </div>
            <div class="modal-actions">
                <button onclick="closeModal()" class="btn-outline">Cancelar</button>
                <button onclick="saveEdit()" class="btn-success">Guardar Cambios</button>
            </div>
        </div>
    </div>

<script>
    let songsData = [];
    let myChart = null;
    let editingIndex = null; 

    window.onload = function() {
        document.getElementById('inputFecha').valueAsDate = new Date();
        const storedData = localStorage.getItem('playlistData');
        if (storedData) {
            songsData = JSON.parse(storedData);
            renderAll();
        }
        document.getElementById('csvFileInput').addEventListener('change', handleFileSelect, false);
    };

    // --- L√≥gica de Negocio ---

    function getActiveSongs() {
        const noExitDate = songsData.filter(s => !s.fecha_salida || s.fecha_salida.trim() === '');
        return noExitDate.slice(-25);
    }

    function calculateDays(startStr, endStr) {
        if (!startStr || !endStr) return '';
        const start = new Date(startStr);
        const end = new Date(endStr);
        if (isNaN(start) || isNaN(end)) return '';
        const diffTime = Math.abs(end - start);
        return Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
    }

    function addSong() {
        const cancion = document.getElementById('inputCancion').value;
        const fecha = document.getElementById('inputFecha').value;
        const escuchas = document.getElementById('inputEscuchas').value;

        if (!cancion || !fecha) { alert("Falta nombre o fecha"); return; }

        songsData.push({
            cancion: cancion,
            fecha_entrada: fecha,
            fecha_salida: '',
            dias_en_playlist: '',
            Escuchas: parseFloat(escuchas) || 0
        });
        saveAndRender();
        document.getElementById('inputCancion').value = '';
    }

    // NUEVA FUNCI√ìN: Sumar 1 a Escuchas
    function addOneEscucha(index) {
        let current = parseFloat(songsData[index].Escuchas) || 0;
        songsData[index].Escuchas = current + 1;
        saveAndRender();
    }

    function markAsExit(index) {
        const today = new Date().toISOString().split('T')[0];
        songsData[index].fecha_salida = today;
        songsData[index].dias_en_playlist = calculateDays(songsData[index].fecha_entrada, today);
        saveAndRender();
    }

    function deleteSong(index) {
        if(confirm('¬øBorrar definitivamente?')) {
            songsData.splice(index, 1);
            saveAndRender();
        }
    }

    // --- Modal ---

    function openEditModal(originalIndex) {
        editingIndex = originalIndex;
        const song = songsData[originalIndex];
        document.getElementById('editCancion').value = song.cancion;
        document.getElementById('editFechaEntrada').value = song.fecha_entrada;
        document.getElementById('editFechaSalida').value = song.fecha_salida || '';
        document.getElementById('editEscuchas').value = song.Escuchas;
        document.getElementById('editModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('editModal').style.display = 'none';
        editingIndex = null;
    }

    function saveEdit() {
        if (editingIndex === null) return;
        const cancion = document.getElementById('editCancion').value;
        const entrada = document.getElementById('editFechaEntrada').value;
        const salida = document.getElementById('editFechaSalida').value;
        const escuchas = document.getElementById('editEscuchas').value;

        if (!cancion || !entrada) { alert("Nombre y Fecha de Entrada son obligatorios"); return; }

        songsData[editingIndex].cancion = cancion;
        songsData[editingIndex].fecha_entrada = entrada;
        songsData[editingIndex].fecha_salida = salida;
        songsData[editingIndex].Escuchas = parseFloat(escuchas) || 0;

        if (salida) {
            songsData[editingIndex].dias_en_playlist = calculateDays(entrada, salida);
        } else {
            songsData[editingIndex].dias_en_playlist = '';
        }

        closeModal();
        saveAndRender();
    }

    window.onclick = function(event) {
        const modal = document.getElementById('editModal');
        if (event.target == modal) closeModal();
    }

    // --- Renderizado ---

    function saveAndRender() {
        localStorage.setItem('playlistData', JSON.stringify(songsData));
        renderAll();
    }

    function renderAll() {
        renderTable();
        updateChart();
        updateStats();
    }

    function renderTable() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        const activeSet = new Set(getActiveSongs()); 
        
        const displayData = songsData.map((item, idx) => ({ item, idx })).reverse();

        displayData.forEach(({ item, idx }) => {
            const isActive = activeSet.has(item);
            const tr = document.createElement('tr');
            tr.className = isActive ? 'active-row' : 'inactive-row';

            tr.innerHTML = `
                <td><strong>${item.cancion}</strong></td>
                <td>${item.fecha_entrada}</td>
                <td>${item.fecha_salida || '-'}</td>
                <td>${item.dias_en_playlist || '-'}</td>
                <td>
                    ${item.Escuchas} 
                    <button onclick="addOneEscucha(${idx})" class="btn-plus" title="Sumar 1 escucha">+1</button>
                </td>
                <td>
                    ${!item.fecha_salida ? 
                        `<button title="Dar Salida Hoy" onclick="markAsExit(${idx})" class="btn-success btn-icon">üèÅ</button>` : ''
                    }
                    <button title="Editar" onclick="openEditModal(${idx})" class="btn-outline btn-icon">‚úèÔ∏è</button>
                    <button title="Borrar" onclick="deleteSong(${idx})" class="btn-danger btn-icon">‚ùå</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function updateChart() {
        const activeSongs = getActiveSongs();
        const ctx = document.getElementById('listenChart').getContext('2d');
        if (myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: activeSongs.map(s => s.cancion),
                datasets: [{
                    label: 'Escuchas',
                    data: activeSongs.map(s => s.Escuchas),
                    backgroundColor: 'rgba(37, 99, 235, 0.6)',
                    borderColor: 'rgba(37, 99, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    function updateStats() {
        document.getElementById('totalSongsCount').textContent = `Total Hist√≥rico: ${songsData.length}`;
        document.getElementById('activeSongsCount').textContent = `Activas (Top 25): ${getActiveSongs().length}`;
    }

    // --- CSV I/O ---

    function exportCSV() {
        const headers = ["cancion", "fecha_entrada", "fecha_salida", "dias_en_playlist", "Escuchas"];
        let csvContent = headers.join(";") + "\r\n";
        songsData.forEach(row => {
            csvContent += `${row.cancion};${row.fecha_entrada};${row.fecha_salida};${row.dias_en_playlist};${row.Escuchas}\r\n`;
        });
        const url = URL.createObjectURL(new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }));
        const link = document.createElement("a");
        link.href = url;
        link.download = "playlist_backup.csv";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function handleFileSelect(evt) {
        const file = evt.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = e => parseCSV(e.target.result);
        reader.readAsText(file);
    }

    function parseCSV(text) {
        const lines = text.trim().split(/\r\n|\n/);
        const result = [];
        for (let i = 1; i < lines.length; i++) {
            const cols = lines[i].split(";");
            if(cols.length < 2) continue;
            result.push({
                cancion: cols[0],
                fecha_entrada: cols[1],
                fecha_salida: cols[2] || "",
                dias_en_playlist: cols[3] || "",
                Escuchas: parseFloat(cols[4]) || 0
            });
        }
        songsData = result;
        saveAndRender();
        alert(`Importadas ${result.length} canciones.`);
    }

    function clearData() {
        if(confirm("¬øBorrar todo?")) {
            localStorage.removeItem('playlistData');
            songsData = [];
            renderAll();
        }
    }
</script>
</body>
</html>
